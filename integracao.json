%%[
    set @Name = requestParameter("Name") // STRING
    set @Email = requestParameter("Email") // STRING
    set @Phone = requestParameter("Phone") // STRING
    set @Professional = requestParameter("Professional") //BOOLEAN
    set @MEI = requestParameter("MEI") //BOOLEAN
    set @Optin_email = requestParameter("Optin_email") //BOOLEAN
    set @Optin_sms = requestParameter("Optin_sms") //BOOLEAN

    SET @results = lookup("tb_lp_color_festival", "Email", "Email", @Email)
  ]%%
  
  <script runat="server">
  
  Platform.Load("core", "1");
  Platform.Response.SetResponseHeader("Access-Control-Allow-Methods", "POST");
  Platform.Response.SetResponseHeader("Access-Control-Allow-Origin", "*");
  Platform.Response.SetResponseHeader("Set-Cookie", "Secure");
  Platform.Response.SetResponseHeader("Strict-Transport-Security", "max-age = 0, cache-control: private, no-cache  ");
  Platform.Response.SetResponseHeader("X-XSS-Protection", "1; mode=block");
  Platform.Response.SetResponseHeader("X-Frame-Options", "Deny");
  Platform.Response.SetResponseHeader("X-Content-Type-Options", "nosniff");
  Platform.Response.SetResponseHeader("Referrer-Policy", "strict-origin-when-cross-origin");
  Platform.Response.SetResponseHeader("Content-Security-Policy", "default-src 'self'");
  
  var Name = Variable.GetValue("@Name");
  var Email = Variable.GetValue("@Email");
  var Phone = Variable.GetValue("@Phone");
  var Professional = Variable.GetValue("@Professional");
  var MEI = Variable.GetValue("@MEI");
  var Optin_email = Variable.GetValue("@Optin_email");
  var Optin_sms = Variable.GetValue("@Optin_sms");
  
    if (isEmpty(Email)){
      Write('{"message":"Não é possível inserir dados Nulos...","statusCode":500}');
    }else{
     try{
         var de = DataExtension.Init('tb_lp_color_festival');
        try{
          var results = Variable.GetValue("@results");
  
          if (isEmpty(results)){
            try{
              de.Rows.Add({Name:Name, Email:Email, Phone:Phone, Professional:Professional, MEI:MEI, Optin_email:Optin_email, Optin_sms:Optin_sms});
  
              Write('{"message":"Cadastro realizado com sucesso.","statusCode":200}');
  
              }catch(err){
               Write(err);
              }
  
           }else{
             Write('{"message":"O Email já preencheu o formulário.","statusCode":400}');
            }
        }catch(err){
           Write('{"message":"Não foi possível consultar as informações","statusCode":500}');
        }
     }catch(err){
       Write('{"message":"Não foi possível iniciar a DataExtension","statusCode":500}');
     }
    }
    function isEmpty(str) {
        return (!str || 0 === str.length);
    }

  </script>